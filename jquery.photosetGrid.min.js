(function($,window,document,undefined){"use strict";var pluginName="photosetGrid",defaults={width:"100%",gutter:"0px",highresLinks:true,lowresWidth:500,onInit:function(){},onComplete:function(){}};function Plugin(element,options){this.element=element;this.options=$.extend({},defaults,options);this._defaults=defaults;this._name=pluginName;this.init()}Plugin.prototype={init:function(){this.options.onInit();this._layoutToArray(this.element,this.options);this._setupRows(this.element,this.options);this._setupColumns(this.element,this.options);this.options.onComplete()},_layoutToArray:function(elem,options){if(options.layout){this.layout=options.layout}else if($(elem).attr("data-layout")){this.layout=$(elem).attr("data-layout")}else{this.layout="1"}this.rows=this.layout.split("");for(var i in this.rows){this.rows[i]=parseInt(this.rows[i])}},_setupRows:function(elem,options){var $images=$(elem).find("img");var imageIndex=0;$.each(this.rows,function(i,val){var rowStart=imageIndex;var rowEnd=imageIndex+val;$images.slice(rowStart,rowEnd).wrapAll('<div class="photoset-row cols-'+val+'"></div>');imageIndex=rowEnd})},_setupColumns:function(elem,options){var _photosetGrid=this;var setupStyles=function(){var $rows=$(elem).find(".photoset-row");var $images=$(elem).find("img");if(options.highresLinks){$images.each(function(){var highres;if($(this).attr("data-highres")){highres=$(this).attr("data-highres")}else{highres=$(this).attr("src")}$(this).wrapAll('<a href="'+highres+'" class="photoset-cell highres-link" />')})}else{$images.each(function(){$(this).wrapAll('<div class="photoset-cell" />')})}var $cells=$(elem).find(".photoset-cell");var $cols1=$(elem).find(".cols-1 .photoset-cell");var $cols2=$(elem).find(".cols-2 .photoset-cell");var $cols3=$(elem).find(".cols-3 .photoset-cell");var $cols4=$(elem).find(".cols-4 .photoset-cell");var $cols5=$(elem).find(".cols-5 .photoset-cell");$(elem).css({"-webkit-box-sizing":"border-box","-moz-box-sizing":"border-box","box-sizing":"border-box",width:options.width});$rows.css({clear:"left",display:"block",overflow:"hidden"});$cells.css({"float":"left",display:"block","line-height":"0"});$images.css({width:"100%",height:"auto"});$cols1.css({width:"100%"});$cols2.css({width:"50%"});$cols3.css({width:"33.3%"});$cols4.css({width:"25%"});$cols5.css({width:"20%"});function resizePhotosetGrid(){$rows.each(function(){var $shortestImg=$(this).find("img:eq(0)");$(this).find("img").each(function(){var $img=$(this);if($img.height()<$shortestImg.height()){$shortestImg=$(this)}if($img.width()>options.lowresWidth&&$img.attr("data-highres")){$img.attr("src",$img.attr("data-highres"))}});var rowHeight=$shortestImg.height();var bufferHeight=Math.floor(rowHeight*.025);$(this).height(rowHeight-bufferHeight);$(this).find("img").each(function(){var marginOffset=(rowHeight-$(this).height())*.5+"px";$(this).css({"margin-top":marginOffset})})})}resizePhotosetGrid();$(window).on("resize",function(event){resizePhotosetGrid()})};$(elem).imagesLoaded(function(){setupStyles()})}};$.fn[pluginName]=function(options){return this.each(function(){if(!$.data(this,"plugin_"+pluginName)){$.data(this,"plugin_"+pluginName,new Plugin(this,options))}})};var BLANK="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///ywAAAAAAQABAAACAUwAOw==";$.fn.imagesLoaded=function(callback){var $this=this,deferred=$.isFunction($.Deferred)?$.Deferred():0,hasNotify=$.isFunction(deferred.notify),$images=$this.find("img").add($this.filter("img")),loaded=[],proper=[],broken=[];if($.isPlainObject(callback)){$.each(callback,function(key,value){if(key==="callback"){callback=value}else if(deferred){deferred[key](value)}})}function doneLoading(){var $proper=$(proper),$broken=$(broken);if(deferred){if(broken.length){deferred.reject($images,$proper,$broken)}else{deferred.resolve($images)}}if($.isFunction(callback)){callback.call($this,$images,$proper,$broken)}}function imgLoadedHandler(event){imgLoaded(event.target,event.type==="error")}function imgLoaded(img,isBroken){if(img.src===BLANK||$.inArray(img,loaded)!==-1){return}loaded.push(img);if(isBroken){broken.push(img)}else{proper.push(img)}$.data(img,"imagesLoaded",{isBroken:isBroken,src:img.src});if(hasNotify){deferred.notifyWith($(img),[isBroken,$images,$(proper),$(broken)])}if($images.length===loaded.length){setTimeout(doneLoading);$images.unbind(".imagesLoaded",imgLoadedHandler)}}if(!$images.length){doneLoading()}else{$images.bind("load.imagesLoaded error.imagesLoaded",imgLoadedHandler).each(function(i,el){var src=el.src;var cached=$.data(el,"imagesLoaded");if(cached&&cached.src===src){imgLoaded(el,cached.isBroken);return}if(el.complete&&el.naturalWidth!==undefined){imgLoaded(el,el.naturalWidth===0||el.naturalHeight===0);return}if(el.readyState||el.complete){el.src=BLANK;el.src=src}})}return deferred?deferred.promise($this):$this};var $event=$.event,$special,dummy={_:0},frame=0,wasResized,animRunning;$special=$event.special.throttledresize={setup:function(){$(this).on("resize",$special.handler)},teardown:function(){$(this).off("resize",$special.handler)},handler:function(event,execAsap){var context=this,args=arguments;wasResized=true;if(!animRunning){setInterval(function(){frame++;if(frame>$special.threshold&&wasResized||execAsap){event.type="throttledresize";$event.dispatch.apply(context,args);wasResized=false;frame=0}if(frame>9){$(dummy).stop();animRunning=false;frame=0}},30);animRunning=true}},threshold:0}})(jQuery,window,document);